suppressMessages({library("sleuth")})
sample_id <- t(read.delim(file.path(snakemake@params["sample_tsv"]), header = TRUE, sep="\t")["sample"])
kal_dirs <- file.path(snakemake@params["kal_dirs"], sample_id)
print("Directories containing kallisto results: \n")
print(kal_dirs)
s2c <- read.table(file.path(snakemake@params["sample_condition"]), header = TRUE, sep = "\t", stringsAsFactors = FALSE)
print(s2c)
# s2c <- dplyr::select(s2c, sample = run_accession, condition)
print("Appending kal_dirs")
s2c <- dplyr::mutate(s2c, path = kal_dirs)
print(s2c)
print("executing sleuth_prep")
so <- sleuth_prep(s2c, extra_bootstrap_summary = TRUE)
print("executing sleuth_fit 1")
so <- sleuth_fit(so, ~condition, 'full')
print("executing sleuth_fit 2")
so <- sleuth_fit(so, ~1, 'reduced')
print("executing sleuth_lrt")
so <- sleuth_lrt(so, 'reduced', 'full')
print("getting sleuth_results")
sleuth_table <- sleuth_results(so, 'reduced:full', 'lrt', show_all = FALSE)
sleuth_significant <- dplyr::filter(sleuth_table, qval <= 0.05)
write(t(sleuth_significant), file = file.path(snakemake@output[0]), sep = "\t")
